name: Debug Nginx Configuration

on:
  workflow_dispatch:

jobs:
  debug:
    name: Check Nginx Config
    runs-on: ubuntu-latest

    if: vars.DEPLOY_HOST != ''

    steps:
      - name: Debug nginx configuration
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Checking nginx config files ==="
            ls -la /root/chatkeep/docker/nginx/sites/ | grep miniapp

            echo ""
            echo "=== Checking if miniapp config exists ==="
            if [ -f "/root/chatkeep/docker/nginx/sites/miniapp.chatmoderatorbot.ru.conf" ]; then
              echo "âœ“ miniapp config file exists"
              echo "File size:"
              ls -lh /root/chatkeep/docker/nginx/sites/miniapp.chatmoderatorbot.ru.conf
            else
              echo "âœ— miniapp config file NOT found!"
            fi

            echo ""
            echo "=== Testing nginx configuration ==="
            docker exec chatkeep-nginx nginx -t

            echo ""
            echo "=== Listing loaded nginx configs ==="
            docker exec chatkeep-nginx ls -la /etc/nginx/sites-enabled/ | grep -E "miniapp|total|^d"

            echo ""
            echo "=== Checking if miniapp config is inside container ==="
            docker exec chatkeep-nginx cat /etc/nginx/sites-enabled/miniapp.chatmoderatorbot.ru.conf | head -20 || echo "File not found in container!"

            echo ""
            echo "=== Restarting nginx to pick up new configs ==="
            docker restart chatkeep-nginx
            sleep 5

            echo ""
            echo "=== Testing HTTP access to miniapp subdomain ==="
            curl -I http://miniapp.chatmoderatorbot.ru/.well-known/acme-challenge/test 2>&1 | head -15
