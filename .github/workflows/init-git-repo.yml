name: Initialize Git Repository on Server

on:
  workflow_dispatch:

jobs:
  init-git:
    name: Initialize Git Repo and Setup SSL
    runs-on: ubuntu-latest

    if: vars.DEPLOY_HOST != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize git repository and setup SSL via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            DEPLOY_PATH="/root/chatkeep"
            cd "$DEPLOY_PATH"

            echo "=== Current directory: $(pwd) ==="
            echo ""

            echo "=== Step 1: Check if git repo exists ==="
            if [ -d ".git" ]; then
              echo "✓ Git repository already exists"
              git status || echo "Git status failed"
            else
              echo "⚠ Not a git repository, initializing..."

              # Initialize git
              git init
              echo "✓ Git initialized"

              # Add remote
              git remote add origin https://github.com/AndVl1/chatkeep.git || echo "Remote might already exist"
              echo "✓ Remote added"

              # Fetch from remote
              echo "Fetching from origin..."
              git fetch origin

              # Checkout production branch
              echo "Checking out production branch..."
              git checkout -b production origin/production || git checkout production

              echo "✓ Git repository initialized and production branch checked out"
            fi

            echo ""
            echo "=== Step 2: Verify current branch and status ==="
            git branch
            git status

            echo ""
            echo "=== Step 3: Verify miniapp config file exists ==="
            if [ -f "docker/nginx/sites/miniapp.chatmoderatorbot.ru.conf" ]; then
              echo "✓ miniapp.chatmoderatorbot.ru.conf exists"
              ls -lh docker/nginx/sites/miniapp.chatmoderatorbot.ru.conf
            else
              echo "✗ miniapp.chatmoderatorbot.ru.conf NOT found!"
              echo "Trying to pull latest changes..."
              git pull origin production || echo "Git pull failed"

              # Check again
              if [ -f "docker/nginx/sites/miniapp.chatmoderatorbot.ru.conf" ]; then
                echo "✓ File now exists after pull"
              else
                echo "✗ File still missing - may need manual intervention"
                exit 1
              fi
            fi

            echo ""
            echo "=== Step 4: Restart nginx container ==="
            docker restart chatkeep-nginx
            echo "Waiting 10 seconds for nginx to start..."
            sleep 10

            echo ""
            echo "=== Step 5: Test nginx configuration ==="
            docker exec chatkeep-nginx nginx -t

            echo ""
            echo "=== Step 6: Verify miniapp config loaded in container ==="
            docker exec chatkeep-nginx ls -la /etc/nginx/sites-enabled/ | grep miniapp || echo "⚠ miniapp config not in container yet"

            echo ""
            echo "=== Step 7: Test HTTP access to ACME challenge ==="
            HTTP_RESPONSE=$(curl -I http://miniapp.chatmoderatorbot.ru/.well-known/acme-challenge/test 2>&1 | head -1)
            echo "HTTP response: $HTTP_RESPONSE"

            if echo "$HTTP_RESPONSE" | grep -q "404"; then
              echo "⚠ Still getting 404 - checking nginx logs..."
              docker logs chatkeep-nginx 2>&1 | tail -20
            fi

            echo ""
            echo "=== Step 8: Run certbot to add miniapp subdomain ==="
            sudo certbot certonly --webroot \
              -w "$DEPLOY_PATH/certbot/webroot" \
              -d chatmoderatorbot.ru \
              -d www.chatmoderatorbot.ru \
              -d miniapp.chatmoderatorbot.ru \
              -d api.chatmoderatorbot.ru \
              -d grafana.chatmoderatorbot.ru \
              -d prometheus.chatmoderatorbot.ru \
              -d admin.chatmoderatorbot.ru \
              --non-interactive \
              --agree-tos \
              --email admin@chatmoderatorbot.ru \
              --expand \
              --force-renewal \
              -v

            CERT_RESULT=$?
            echo "Certbot exit code: $CERT_RESULT"

            if [ $CERT_RESULT -eq 0 ]; then
              echo "✓ Certificate updated successfully!"

              # Show certificate info
              echo ""
              echo "Certificate details:"
              sudo certbot certificates | grep -A 15 "chatmoderatorbot.ru"

              # Reload nginx to pick up new certificate
              echo ""
              echo "Reloading nginx..."
              docker exec chatkeep-nginx nginx -s reload

              echo ""
              echo "✓ All done! Miniapp subdomain setup complete"

              # Test HTTPS access
              echo ""
              echo "=== Testing HTTPS access ==="
              curl -I https://miniapp.chatmoderatorbot.ru 2>&1 | head -5
            else
              echo "✗ Certbot failed with exit code $CERT_RESULT"
              echo "Check logs above for details"
              exit 1
            fi
