name: Build Mobile Release

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Build flavor'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      build_type:
        description: 'Build type'
        required: true
        type: choice
        options:
          - debug
          - release
        default: 'release'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate build number
        id: buildnumber
        uses: onyxmueller/build-tag-number@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Decode Keystore
        if: inputs.build_type == 'release'
        run: |
          # Check if production keystore exists
          if [ "${{ inputs.flavor }}" == "production" ] && [ -n "${{ secrets.ANDROID_KEYSTORE_BASE_64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE_64 }}" | base64 -d > /tmp/keystore.jks
            echo "ANDROID_KEYSTORE_PATH=/tmp/keystore.jks" >> $GITHUB_ENV
            echo "ANDROID_KEYSTORE_PASS=${{ secrets.ANDROID_KEYSTORE_PASS }}" >> $GITHUB_ENV
            echo "ANDROID_KEYSTORE_KEY_PASS=${{ secrets.ANDROID_KEYSTORE_KEY_PASS }}" >> $GITHUB_ENV
            echo "ANDROID_KEYSTORE_ALIAS=${{ secrets.ANDROID_KEYSTORE_ALIAS }}" >> $GITHUB_ENV
            echo "Keystore configured for production release"
          else
            echo "No keystore configured - will use debug signing"
          fi

      - name: Build APK
        working-directory: chatkeep-admin
        run: |
          FLAVOR="${{ inputs.flavor }}"
          BUILD_TYPE="${{ inputs.build_type }}"
          FLAVOR_CAPITALIZED="$(echo ${FLAVOR:0:1} | tr '[:lower:]' '[:upper:]')${FLAVOR:1}"
          BUILD_TYPE_CAPITALIZED="$(echo ${BUILD_TYPE:0:1} | tr '[:lower:]' '[:upper:]')${BUILD_TYPE:1}"

          echo "Building: assemble${FLAVOR_CAPITALIZED}${BUILD_TYPE_CAPITALIZED}"
          ./gradlew :composeApp:assemble${FLAVOR_CAPITALIZED}${BUILD_TYPE_CAPITALIZED}

      - name: Rename APK with version
        run: |
          BUILD_NUMBER=${{ steps.buildnumber.outputs.build_number }}
          FLAVOR="${{ inputs.flavor }}"
          BUILD_TYPE="${{ inputs.build_type }}"

          # Find the APK
          APK_PATH=$(find chatkeep-admin/composeApp/build/outputs/apk -name "*.apk" -type f | head -1)

          if [ -n "$APK_PATH" ]; then
            NEW_NAME="chatkeep-admin-${FLAVOR}-${BUILD_TYPE}-build${BUILD_NUMBER}.apk"
            mkdir -p chatkeep-admin/release
            cp "$APK_PATH" "chatkeep-admin/release/$NEW_NAME"
            echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
            echo "Built APK: $NEW_NAME"
          else
            echo "Error: APK not found"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatkeep-admin-${{ inputs.flavor }}-${{ inputs.build_type }}-build${{ steps.buildnumber.outputs.build_number }}
          path: chatkeep-admin/release/chatkeep-admin-*.apk
          retention-days: 90

      - name: Add build summary
        run: |
          echo "### Android APK Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Flavor**: ${{ inputs.flavor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ steps.buildnumber.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Name**: ${{ env.APK_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 90 days" >> $GITHUB_STEP_SUMMARY
