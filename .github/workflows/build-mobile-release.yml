name: Build Mobile Release

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Build flavor'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      build_type:
        description: 'Build type'
        required: true
        type: choice
        options:
          - debug
          - release
        default: 'release'

permissions:
  contents: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate build number
        id: buildnumber
        uses: onyxmueller/build-tag-number@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build APK
        working-directory: chatkeep-admin
        run: |
          FLAVOR="${{ inputs.flavor }}"
          BUILD_TYPE="${{ inputs.build_type }}"
          FLAVOR_CAPITALIZED="$(echo ${FLAVOR:0:1} | tr '[:lower:]' '[:upper:]')${FLAVOR:1}"
          BUILD_TYPE_CAPITALIZED="$(echo ${BUILD_TYPE:0:1} | tr '[:lower:]' '[:upper:]')${BUILD_TYPE:1}"

          echo "Building: assemble${FLAVOR_CAPITALIZED}${BUILD_TYPE_CAPITALIZED}"
          ./gradlew :composeApp:assemble${FLAVOR_CAPITALIZED}${BUILD_TYPE_CAPITALIZED}

      - name: Sign APK
        if: inputs.build_type == 'release'
        id: sign
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: chatkeep-admin/composeApp/build/outputs/apk/${{ inputs.flavor }}/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE_64 }}
          alias: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          keyPassword: ${{ secrets.ANDROID_KEYSTORE_KEY_PASS }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Prepare APK for upload
        id: prepare
        run: |
          BUILD_NUMBER=${{ steps.buildnumber.outputs.build_number }}
          FLAVOR="${{ inputs.flavor }}"
          BUILD_TYPE="${{ inputs.build_type }}"

          mkdir -p chatkeep-admin/release

          # Use signed APK if available, otherwise use unsigned
          if [ -n "${{ steps.sign.outputs.signedReleaseFile }}" ]; then
            APK_PATH="${{ steps.sign.outputs.signedReleaseFile }}"
            SIGNED_SUFFIX="-signed"
            echo "Using signed APK: $APK_PATH"
          else
            APK_PATH=$(find chatkeep-admin/composeApp/build/outputs/apk -name "*.apk" -type f | head -1)
            SIGNED_SUFFIX=""
            echo "Using unsigned APK: $APK_PATH"
          fi

          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            NEW_NAME="chatkeep-admin-${FLAVOR}-${BUILD_TYPE}${SIGNED_SUFFIX}-build${BUILD_NUMBER}.apk"
            cp "$APK_PATH" "chatkeep-admin/release/$NEW_NAME"
            echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
            echo "Prepared APK: $NEW_NAME"
          else
            echo "Error: APK not found"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatkeep-admin-${{ inputs.flavor }}-${{ inputs.build_type }}-build${{ steps.buildnumber.outputs.build_number }}
          path: chatkeep-admin/release/chatkeep-admin-*.apk
          retention-days: 90

      - name: Add build summary
        run: |
          echo "### Android APK Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Flavor**: ${{ inputs.flavor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ steps.buildnumber.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Name**: ${{ steps.prepare.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed**: ${{ steps.sign.outputs.signedReleaseFile != '' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 90 days" >> $GITHUB_STEP_SUMMARY
