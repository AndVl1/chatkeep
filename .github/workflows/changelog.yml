name: Generate Changelog

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main, production]

concurrency:
  group: changelog-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-changelog-jar:
    name: Build Changelog Generator JAR
    runs-on: ubuntu-latest
    if: secrets.OPENROUTER_API_KEY != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Shadow JAR
        id: jar-cache
        uses: actions/cache@v4
        with:
          path: tools/changelog-generator/build/libs/
          key: changelog-jar-${{ hashFiles('tools/changelog-generator/src/**', 'tools/changelog-generator/build.gradle.kts') }}

      - name: Build Shadow JAR
        if: steps.jar-cache.outputs.cache-hit != 'true'
        working-directory: tools/changelog-generator
        run: ../../gradlew shadowJar

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-generator-jar
          path: tools/changelog-generator/build/libs/changelog-generator.jar
          retention-days: 1

  generate-changelog:
    name: Generate and Post Changelog
    needs: build-changelog-jar
    runs-on: ubuntu-latest
    if: secrets.OPENROUTER_API_KEY != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: changelog-generator-jar
          path: tools/changelog-generator/build/libs/

      - name: Generate Changelog
        id: generate
        continue-on-error: true
        working-directory: tools/changelog-generator
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_MODEL: ${{ vars.CHANGELOG_MODEL || 'deepseek/deepseek-chat-v3-0324' }}
        run: |
          # Run changelog generator and capture output
          java -jar build/libs/changelog-generator.jar \
            --pr-number=${{ github.event.pull_request.number }} \
            --repo=${{ github.repository }} \
            --base-branch=${{ github.event.pull_request.base.ref }} \
            --head-branch=${{ github.event.pull_request.head.ref }} \
            --mode=generate | tee changelog-output.txt

          # Extract production changes section if it exists
          if grep -q "Production Changes:" changelog-output.txt; then
            echo "has_production_changes=true" >> $GITHUB_OUTPUT
            # Extract production changes section (everything after "Production Changes:")
            sed -n '/Production Changes:/,$p' changelog-output.txt > production-changes.txt
            # Read the content and set as output (escape newlines)
            {
              echo 'production_changelog<<EOF'
              cat production-changes.txt
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "has_production_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Notification
        if: |
          steps.generate.outputs.has_production_changes == 'true' &&
          secrets.TELEGRAM_CHANGELOG_BOT_TOKEN != '' &&
          secrets.TELEGRAM_CHANGELOG_CHAT_ID != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHANGELOG_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_CHANGELOG_BOT_TOKEN }}
          format: markdown
          disable_web_page_preview: true
          message: |
            ðŸš€ PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.head.ref }}

            ${{ steps.generate.outputs.production_changelog }}

            [View PR](${{ github.event.pull_request.html_url }})
