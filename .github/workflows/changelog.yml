name: Generate Changelog

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main, production]

concurrency:
  group: changelog-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  generate-changelog:
    name: Generate and Post Changelog
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.draft == false }}

    steps:
      - name: Check API key
        id: check-key
        env:
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_CHANGELOG }}
        run: |
          if [ -z "$OPENROUTER_KEY" ]; then
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::warning::OPENROUTER_API_KEY is not set. Skipping changelog generation."
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Shadow JAR
        if: steps.check-key.outputs.has_key == 'true'
        id: jar-cache
        uses: actions/cache@v4
        with:
          path: tools/changelog-generator/build/libs/
          key: changelog-jar-${{ hashFiles('tools/changelog-generator/src/**', 'tools/changelog-generator/build.gradle.kts') }}

      - name: Build Shadow JAR
        if: steps.check-key.outputs.has_key == 'true' && steps.jar-cache.outputs.cache-hit != 'true'
        working-directory: tools/changelog-generator
        run: |
          chmod +x ../../gradlew
          ../../gradlew shadowJar --no-daemon

      - name: Generate Changelog
        if: steps.check-key.outputs.has_key == 'true'
        id: generate
        continue-on-error: true
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_CHANGELOG }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_MODEL: ${{ vars.CHANGELOG_MODEL || 'deepseek/deepseek-chat-v3-0324' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          java -jar tools/changelog-generator/build/libs/changelog-generator.jar \
            --pr-number="$PR_NUMBER" \
            --repo="$REPO" \
            --base-branch="$BASE_BRANCH" \
            --head-branch="$HEAD_BRANCH" \
            --mode=generate 2>&1 | tee changelog-output.txt

          # Check for production changes in output (Russian format from formatter)
          if grep -q "ÐŸÑ€Ð¾Ð´Ð°ÐºÑˆÐ½-Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:" changelog-output.txt; then
            echo "has_production_changes=true" >> $GITHUB_OUTPUT
            # Extract the Telegram notification section
            sed -n '/^ðŸš€ PR/,/^$/p' changelog-output.txt > telegram-message.txt
            if [ -s telegram-message.txt ]; then
              {
                echo 'telegram_message<<EOF'
                cat telegram-message.txt
                echo EOF
              } >> $GITHUB_OUTPUT
            fi
          else
            echo "has_production_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Notification
        if: |
          steps.generate.outputs.has_production_changes == 'true' &&
          steps.generate.outcome == 'success'
        continue-on-error: true
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_CHANGELOG_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHANGELOG_CHAT_ID }}
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets not configured. Skipping notification."
            exit 0
          fi

          MESSAGE=$(cat <<'MSGEOF'
          ${{ steps.generate.outputs.telegram_message }}

          [PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})
          MSGEOF
          )

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${TG_CHAT}\", \"text\": $(echo "$MESSAGE" | jq -Rs .), \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"
