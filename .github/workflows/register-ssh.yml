name: Register SSH Key

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - production
          - test
        default: 'test'
      ssh_public_key:
        description: 'SSH public key to add (e.g., ssh-ed25519 AAAA... user@host)'
        required: true
        type: string

jobs:
  register-ssh-key:
    name: Register SSH Public Key
    runs-on: ubuntu-latest

    # Only run if server credentials are configured
    if: vars.DEPLOY_HOST != '' || vars.TEST_DEPLOY_HOST != ''

    env:
      # Environment-specific variables
      IS_PROD: ${{ github.event.inputs.environment == 'production' }}
      DEPLOY_HOST: ${{ github.event.inputs.environment == 'production' && vars.DEPLOY_HOST || vars.TEST_DEPLOY_HOST }}
      DEPLOY_SSH_KEY: ${{ github.event.inputs.environment == 'production' && secrets.DEPLOY_SSH_KEY || secrets.TEST_SSH_PRIVATE_KEY }}
      ENV_NAME: ${{ github.event.inputs.environment }}

    steps:
      - name: Validate SSH public key format
        run: |
          KEY="${{ github.event.inputs.ssh_public_key }}"

          # Check if key starts with valid SSH key type
          if [[ ! "$KEY" =~ ^(ssh-rsa|ssh-ed25519|ecdsa-sha2-nistp256|ecdsa-sha2-nistp384|ecdsa-sha2-nistp521)[[:space:]] ]]; then
            echo "Error: Invalid SSH public key format"
            echo "Expected format: ssh-ed25519 AAAA... user@host"
            echo "Supported key types: ssh-rsa, ssh-ed25519, ecdsa-sha2-nistp*"
            exit 1
          fi

          # Check if key has at least 3 parts (type, key, comment)
          PARTS=$(echo "$KEY" | wc -w)
          if [ "$PARTS" -lt 2 ]; then
            echo "Error: SSH key must have at least key type and key data"
            exit 1
          fi

          echo "SSH key validation passed"

      - name: Add SSH key to server
        uses: appleboy/ssh-action@v1.2.0
        env:
          ENV_NAME: ${{ env.ENV_NAME }}
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ env.DEPLOY_SSH_KEY }}
          envs: ENV_NAME
          script: |
            echo "Registering SSH key for $ENV_NAME environment"

            # Create .ssh directory if it doesn't exist
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            # Create authorized_keys if it doesn't exist
            touch ~/.ssh/authorized_keys
            chmod 600 ~/.ssh/authorized_keys

            # Extract key type and key data for comparison (first two fields)
            NEW_KEY_FINGERPRINT=$(echo "${{ github.event.inputs.ssh_public_key }}" | awk '{print $1" "$2}')

            # Check if key already exists (compare fingerprints)
            if grep -F "$NEW_KEY_FINGERPRINT" ~/.ssh/authorized_keys > /dev/null 2>&1; then
              echo "Warning: This SSH key is already registered"
              echo "Skipping duplicate entry"
              exit 0
            fi

            # Add the new key
            echo "${{ github.event.inputs.ssh_public_key }}" >> ~/.ssh/authorized_keys
            echo "SSH key successfully added to authorized_keys for $ENV_NAME"

            # Show the number of registered keys
            KEY_COUNT=$(wc -l < ~/.ssh/authorized_keys)
            echo "Total registered keys: $KEY_COUNT"

      - name: Verify key registration
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ env.DEPLOY_SSH_KEY }}
          script: |
            echo "Registered SSH keys:"
            echo "===================="

            # Show key types and comments (without exposing full keys)
            awk '{print NR". "$1" ... "$NF}' ~/.ssh/authorized_keys

            echo ""
            echo "Total keys: $(wc -l < ~/.ssh/authorized_keys)"

      - name: Summary
        run: |
          echo "### SSH Key Registration Complete :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The SSH public key has been successfully added to the server." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENV_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ env.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**User:** ${{ vars.DEPLOY_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can now use SSH key authentication to access the server." >> $GITHUB_STEP_SUMMARY
