name: Create Production PR

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'PR description (optional)'
        required: false
        type: string

jobs:
  create-pr:
    name: Create PR to Production
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch production branch
        run: |
          git fetch origin production:production

      - name: Create RC branch
        id: rc_branch
        run: |
          # Generate RC branch name with DD-MM-YYYY format
          RC_DATE=$(date +'%d-%m-%Y')
          RC_BRANCH="rc-${RC_DATE}"

          echo "branch_name=$RC_BRANCH" >> $GITHUB_OUTPUT

          # Create RC branch from main
          git checkout main
          git checkout -b "$RC_BRANCH"

          # Push RC branch to origin
          git push origin "$RC_BRANCH"

      - name: Get commit summary
        id: summary
        run: |
          # Get commits between production and main
          COMMITS=$(git log --oneline production..main --pretty=format:"- %s (%h)" | head -20)

          if [ -z "$COMMITS" ]; then
            echo "No new commits to deploy"
            exit 1
          fi

          # Store commits for PR body (escape for JSON)
          COMMITS_ESCAPED=$(echo "$COMMITS" | jq -Rs .)
          echo "commits=$COMMITS_ESCAPED" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        env:
          RC_BRANCH: ${{ steps.rc_branch.outputs.branch_name }}
        with:
          script: |
            const commits = ${{ steps.summary.outputs.commits }};
            const rcBranch = process.env.RC_BRANCH;

            // Check if PR already exists
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${rcBranch}`,
              base: 'production',
              state: 'open'
            });

            if (prs.length > 0) {
              console.log(`PR #${prs[0].number} already exists: ${prs[0].html_url}`);
              core.setOutput('pr_number', prs[0].number);
              return;
            }

            // Create PR
            const body = `## Changes to Deploy

            ${commits}

            ## Checklist

            - [ ] Backend changes tested locally
            - [ ] Frontend changes tested locally
            - [ ] Database migrations reviewed
            - [ ] Environment variables updated (if needed)
            - [ ] Monitoring configured (if needed)`;

            // Format date as DD-MM-YYYY
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateStr = `${day}-${month}-${year}`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deploy to Production - ${dateStr}`,
              head: rcBranch,
              base: 'production',
              body: body
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('pr_number', pr.number);

      - name: Wait for potential auto-triggered changelog
        run: sleep 15

      - name: Dispatch changelog if not already running
        if: steps.create-pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          RC_BRANCH: ${{ steps.rc_branch.outputs.branch_name }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const rcBranch = process.env.RC_BRANCH;

            // Check if changelog workflow is already running for this PR
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'changelog.yml',
              status: 'in_progress'
            });

            const { data: queuedRuns } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'changelog.yml',
              status: 'queued'
            });

            const allActiveRuns = [...runs.workflow_runs, ...queuedRuns.workflow_runs];

            // Also check recently completed runs (last 5 min)
            const { data: completedRuns } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'changelog.yml',
              status: 'completed',
              per_page: 5
            });

            const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);
            const recentCompleted = completedRuns.workflow_runs.filter(
              r => new Date(r.created_at) > fiveMinAgo
            );

            const allRuns = [...allActiveRuns, ...recentCompleted];

            if (allRuns.length > 0) {
              console.log(`Changelog workflow already active/recent (${allRuns.length} runs). Skipping dispatch.`);
              for (const run of allRuns) {
                console.log(`  - Run #${run.id}: ${run.status} (created: ${run.created_at})`);
              }
              return;
            }

            // Dispatch changelog workflow
            console.log(`No active changelog runs found. Dispatching for PR #${prNumber}...`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'changelog.yml',
              ref: rcBranch,
              inputs: {
                'pr-number': prNumber.toString()
              }
            });

            console.log(`Changelog workflow dispatched for PR #${prNumber}`);
