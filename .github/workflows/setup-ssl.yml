name: Setup SSL Certificate

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  setup-ssl:
    name: Run SSL Setup on Server
    runs-on: ubuntu-latest

    # Only run if server credentials are configured
    if: vars.DEPLOY_HOST != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SSL setup via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH || '~/chatkeep' }}

            echo "Running SSL certificate setup..."
            echo "This will add miniapp.chatmoderatorbot.ru to the certificate"

            # Run certbot directly with all domains including miniapp
            echo "Running certbot with domains: chatmoderatorbot.ru www miniapp api grafana prometheus admin"
            sudo certbot certonly --webroot \
              -w /root/chatkeep/certbot/webroot \
              -d chatmoderatorbot.ru \
              -d www.chatmoderatorbot.ru \
              -d miniapp.chatmoderatorbot.ru \
              -d api.chatmoderatorbot.ru \
              -d grafana.chatmoderatorbot.ru \
              -d prometheus.chatmoderatorbot.ru \
              -d admin.chatmoderatorbot.ru \
              --non-interactive \
              --agree-tos \
              --email admin@chatmoderatorbot.ru \
              --expand \
              --force-renewal \
              -v

            CERT_RESULT=$?
            echo "Certbot exit code: $CERT_RESULT"

            if [ $CERT_RESULT -eq 0 ]; then
              echo "✓ Certificate updated successfully!"

              # Show certificate info
              echo "Certificate details:"
              sudo certbot certificates | grep -A 10 "chatmoderatorbot.ru"
            else
              echo "✗ Certbot failed with exit code $CERT_RESULT"
              exit 1
            fi

            echo "SSL setup completed!"

            # Reload nginx to pick up new certificate
            echo "Reloading nginx..."
            docker exec chatkeep-nginx nginx -s reload || echo "Nginx reload failed, but continuing..."

            echo "Done! Certificate should now include miniapp.chatmoderatorbot.ru"
