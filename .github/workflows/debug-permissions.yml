name: Debug Permissions

on:
  workflow_dispatch:

jobs:
  debug:
    name: Check File Permissions
    runs-on: ubuntu-latest

    if: vars.DEPLOY_HOST != ''

    steps:
      - name: Check permissions via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            DEPLOY_PATH="/root/chatkeep"

            echo "=== Checking host files ==="
            ls -la "$DEPLOY_PATH/mini-app/dist/" 2>&1 | head -20 || echo "dist directory not found"

            echo ""
            echo "=== Checking nginx container mounts ==="
            docker inspect chatkeep-nginx --format='{{range .Mounts}}{{.Source}} -> {{.Destination}} ({{.Mode}}){{println}}{{end}}'

            echo ""
            echo "=== Checking nginx logs ==="
            docker logs chatkeep-nginx --tail 30 2>&1 | grep -i "forbidden\|permission\|denied" || echo "No permission errors"

            echo ""
            echo "=== Checking container /var/www ==="
            docker exec chatkeep-nginx ls -la /var/www/ 2>&1 || echo "Cannot access /var/www"

            echo ""
            echo "=== Checking container mini-app ==="
            docker exec chatkeep-nginx ls -la /var/www/mini-app/ 2>&1 | head -10 || echo "Cannot access mini-app"

            echo ""
            echo "=== Nginx process user ==="
            docker exec chatkeep-nginx ps aux | grep nginx | head -3

            echo ""
            echo "=== Test file read ==="
            docker exec chatkeep-nginx cat /var/www/mini-app/index.html 2>&1 | head -5 || echo "Cannot read index.html"
